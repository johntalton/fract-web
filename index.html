<!DOCTYPE html>
<html>
	<head>
		<script type="module" defer async>
			const worker = new Worker('worker.js', { type: 'module' })

			const canvas = document.getElementById('kvs')
			const context = canvas.getContext('2d', { colorSpace: "display-p3" })
			context.imageSmoothingEnabled = false


			function pallet(index) {
				return `hsl(${index * 2.5} 80% 50%)`
			}

			const setPixelR = (x, y, c) => {
				// console.log(x, y, c)
				context.fillStyle = c
				context.fillRect(x, y, 1, 1)
			}

			const setPixelC = (x, y, c) => {
				context.fillStyle = c
				context.beginPath()
				context.ellipse(x, y, 1, 1, 0, 0, 360)
				context.fill()
			}

			const setPixel = setPixelR




			worker.onerror = event => console.warn(event)
			worker.onmessage = event => {
				const { data } = event
				const { box, point, target, depth, maxDepth } = data
				const { width, height } = target

				const actualWidth = canvas.width
				const actualHeight = canvas.height

				const rx = (point.x - box.x1) / (box.x2 - box.x1)
				const ry =  (point.y - box.y1) / (box.y2 - box.y1)

				const actualX = rx * (actualWidth)
				const actualY =  ry * (actualHeight)

				const color = depth === maxDepth ? 'black' : pallet(depth * 10)
				setPixel(actualX, actualY, color)
			}

			worker.postMessage({
				target: { width: 1600, height: 900 },
				box: { x1: -2, y1: -2, x2: 2, y2: 2 },
				maxDepth: 50
			})

			canvas.addEventListener('mousedown', event => {
				// drag = true
				const x = document.getElementById('skrn')

				screenCache = { x1: event.offsetX, y1: event.offsetY }

				x.style.setProperty('--x1', `${event.offsetX}px`)
				x.style.setProperty('--y1', `${event.offsetY}px`)
				x.style.setProperty('--x2', `${event.offsetX}px`)
				x.style.setProperty('--y2', `${event.offsetY}px`)

				x.toggleAttribute('data-active', true)
			})

			canvas.addEventListener('mouseup', event => {
				// drag = false
				const x = document.getElementById('skrn')
				x.toggleAttribute('data-active', false)

				const cw = canvas.clientWidth
				const ch = canvas.clientHeight

				if(Math.abs(event.offsetX - screenCache.x1) < 15) { return }
				if(Math.abs(event.offsetY - screenCache.y1) < 15) { return }

				const x1r = screenCache.x1 / cw
				const y1r = screenCache.y1 / ch

				const x2r = event.offsetX / cw
				const y2r = event.offsetY / ch


				const newX1 = X1 + ((X2 - X1) * x1r)
				const newY1 = Y1 + ((Y2 - Y1) * y1r)

				const newX2 = X1 + ((X2 - X1) * x2r)
				const newY2 = Y1 + ((Y2 - Y1) * y2r)

				viewCache.push({ x1: X1, y1: Y1, x2: X2, y2: Y2 })

				X1 = newX1
				Y1 = newY1
				X2 = newX2
				Y2 = newY2

				requestAnimationFrame(render)
			})

			canvas.addEventListener('mousemove', event => {
				const x = document.getElementById('skrn')
				if(!x.hasAttribute('data-active')) { return }

				x.style.setProperty('--x2', `${event.offsetX}px`)
				x.style.setProperty('--y2', `${event.offsetY}px`)
			})

			document.addEventListener('keyup', event => {
				// event.keyCode === 8
				if(event.key !== 'Backspace') { return }

				const last = viewCache.pop()
				if(last === undefined) { return }
				console.log('pop', last)

				X1 = last.x1
				Y1 = last.y1
				X2 = last.x2
				Y2 = last.y2

				requestAnimationFrame(render)
			})

		</script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			html {
				display: block;
				background-color: white;
			}

			body {
				display: flex;
				justify-content: center;

				margin-block-start: 2em;
				margin-inline: 2em;
			}

			canvas {
				cursor: zoom-in;

				display: block;
				aspect-ratio: 16 / 9;

				width: 100%;
  			/* max-width: 100vw; */

				/* border: 10px solid transparent; */
				background-color: transparent;
				color: transparent;
				box-shadow: 2px 2px 1em rgb(124, 124, 124);
			}
		</style>
		<style>
			[data-hug] {
				display: block;
				position: relative;
				width: 100%;
			}

			[data-screen] {
				--x1: 50px;
				--y1: 100px;
				--x2: 500px;
				--y2: 200px;

				position: absolute;
				display: block;
				pointer-events: none;

				top: var(--y1, 0);
				left: var(--x1, 0);

				width: calc(var(--x2) - var(--x1));
				height: calc(var(--y2) - var(--y1));

				border: 1px solid white;
				background-color: rgb(255 255 255 / 0.25);
			}

			[data-screen]:not([data-active]) {
				display: none;
			}
		</style>
	</head>
	<body>
		<div data-hug>
			<canvas id="kvs" width="1600" height="900"></canvas>
			<div id="skrn" data-screen></div>
		</div>
	</body>
</html>
